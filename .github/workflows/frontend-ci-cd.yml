name: Secure Deploy Frontend to App Engine

on:
  push:
    branches:
      - main
    paths:
      - "frontend/**"
      - ".github/workflows/deploy-frontend-secure.yml"

permissions:
  id-token: write   # REQUIRED for OIDC
  contents: read

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ğŸ” Secure authentication (NO JSON KEY)
    - name: Authenticate to Google Cloud (OIDC)
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/github-pool/providers/github
        service_account: github-actions@PROJECT_ID.iam.gserviceaccount.com

    - name: Set up gcloud
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: PROJECT_ID

    # ğŸ“¦ Install dependencies
    - name: Install frontend dependencies
      working-directory: frontend
      run: npm ci

    # ğŸ§¹ Lint (code quality)
    - name: Lint frontend
      working-directory: frontend
      run: npm run lint

    # ğŸ—ï¸ Build frontend
    - name: Build frontend
      working-directory: frontend
      run: npm run build

    # ğŸ” Verify build output (important)
    - name: Verify build output
      run: ls -la frontend/dist

    # ğŸš€ Deploy without auto-promote (safe)
    - name: Deploy frontend to App Engine
      run: |
        gcloud app deploy frontend/app.yaml \
          --quiet \
          --no-promote
